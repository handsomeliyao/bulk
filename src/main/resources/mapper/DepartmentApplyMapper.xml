<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.liyao.bulk.mapper.DepartmentApplyMapper">

    <resultMap id="DepartmentApplyMap" type="com.liyao.bulk.model.DepartmentApply">
        <id column="id" property="id"/>
        <result column="arr_no" property="arrNo"/>
        <result column="dept_id" property="deptId"/>
        <result column="dept_name" property="deptName"/>
        <result column="remark" property="remark"/>
        <result column="oper_type" property="operType"/>
        <!-- 申请状态枚举：PENDING(待复核)、REJECTED(复核拒绝)、CANCELED(已撤销) -->
        <result column="arr_status" property="operStatus"/>
        <result column="arr_oper_code" property="operCode"/>
        <result column="arr_oper_name" property="operName"/>
        <result column="arr_date" property="arrDate"/>
        <result column="review_oper_code" property="reviewOperCode"/>
        <result column="review_oper_name" property="reviewOperName"/>
        <result column="review_time" property="reviewTime"/>
        <result column="dept_status" property="deptStatus"/>
    </resultMap>

    <select id="selectById" resultMap="DepartmentApplyMap">
        SELECT id, arr_no, dept_id, dept_name, remark, oper_type, arr_status,
               arr_oper_code, arr_oper_name, arr_date, review_oper_code, review_oper_name, review_time,
               dept_status
        FROM department_apply
        WHERE id = #{id}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO department_apply (
            arr_no, dept_id, dept_name, remark, oper_type, arr_status,
            arr_oper_code, arr_oper_name, arr_date, review_oper_code, review_oper_name, review_time,
            dept_status
        ) VALUES (
            #{arrNo}, #{deptId}, #{deptName}, #{remark}, #{operType}, #{operStatus},
            #{operCode}, #{operName}, #{arrDate}, #{reviewOperCode}, #{reviewOperName}, #{reviewTime},
            #{deptStatus}
        )
    </insert>

    <select id="selectByCondition" resultType="com.liyao.bulk.dto.DepartmentApplySummary">
        SELECT id,
               arr_no AS arrNo,
               dept_id AS deptId,
               dept_name AS deptName,
               remark AS remark,
               oper_type AS operType,
               arr_status AS arrStatus,
               dept_status AS deptStatus,
               arr_oper_name AS arrOperName,
               arr_oper_code AS arrOperCode,
               arr_date AS arrDate,
               review_oper_name AS reviewOperName,
               review_oper_code AS reviewOperCode,
               review_time AS reviewTime
        FROM department_apply
        <where>
            <if test="statusList != null and statusList.size() > 0">
                AND arr_status IN
                <foreach collection="statusList" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="startTime != null">
                AND arr_date &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND arr_date &lt;= #{endTime}
            </if>
            <if test="arrNo != null and arrNo != ''">
                AND arr_no = #{arrNo}
            </if>
            <if test="deptName != null and deptName != ''">
                AND dept_name LIKE CONCAT('%', #{deptName}, '%')
            </if>
            <if test="operType != null and operType != ''">
                AND oper_type = #{operType}
            </if>
        </where>
        ORDER BY arr_date ASC, arr_no ASC
    </select>

    <update id="updateStatus">
        UPDATE department_apply
        SET arr_status = #{status},
            review_oper_code = #{reviewOperCode},
            review_oper_name = #{reviewOperName},
            review_time = #{reviewTime}
        WHERE id = #{id}
    </update>

    <update id="updateDeptId">
        UPDATE department_apply
        SET dept_id = #{deptId}
        WHERE id = #{id}
    </update>

    <select id="countPendingByDeptId" resultType="int">
        SELECT COUNT(1) FROM department_apply
        WHERE dept_id = #{deptId} AND arr_status = 'PENDING'
    </select>
</mapper>


